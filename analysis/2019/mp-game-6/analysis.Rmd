---
title: "Cultural Ratchet Data Exploration"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(reshape2)
library(purrr)
library(jsonlite)
library(tidyr) 
library(dplyr)
library(tidyboot)
library(ggplot2)
library(scales)
library(stringr)
library(digest)
library(ggthemes)
library(forcats)
library(ggalt)
```


# Load Concept Summary
```{r}
concept_summary_fp <- c("../../../experiments/mp-game-6/stimuli/fifty_rules/concept_summary.json")
concept_summary <- do.call(rbind.data.frame, jsonlite::fromJSON(concept_summary_fp)) %>%
  mutate(chance_rate= p_test_belongs_to_concept*p_test_belongs_to_concept + (1 -p_test_belongs_to_concept) * (1-p_test_belongs_to_concept))
```

# Complete Games
```{r}
# Load Test Trial Responses
temp <- list.files(
  "../../../data/mp-game-6/complete_games/logTest",
  pattern="*.csv",
  full.names=TRUE
)
test_complete_games <- do.call(rbind, lapply(temp, read.csv, sep=""))

# Load Test Summary Stats
temp <- list.files(
    "../../../data/mp-game-6/complete_games/logScores",
  pattern="*.csv",
  full.names=TRUE
)
scores_complete_games <- do.call(rbind, lapply(temp, read.csv, sep=""))

# Load Chat Messages
temp <- list.files(
    "../../../data/mp-game-6/complete_games/chatMessage",
  pattern="*.tsv",
  full.names=TRUE
)
msgs_complete_games <-do.call(rbind, lapply(temp, readr::read_tsv)) %>%
  group_by(gameid)
```

## Distribution of Complete Data
```{r}
num_complete_games_played <- scores_complete_games %>%
  count(rule_idx) %>%
  mutate(n = n/2)

num_complete_games_played$n <- as.factor(num_complete_games_played$n)

ggplot(data=num_complete_games_played, aes(x=rule_idx, y=n)) +
  geom_bar(stat="identity") +
  labs(
    title = "Data Distribution of Complete Games",
    x = "Rule Index",
    y = "Number of Samples"
  )  +
  ylim(0, 10) +
  scale_y_discrete()
```


## Student Performance Vs. Teacher Performance 
```{r}
# Accuracies
complete_test_explorer <- scores_complete_games %>%
  filter(role == "explorer") %>%
  mutate(correct = hits + correct_rejections) %>%
  mutate(incorrect = misses + false_alarms) %>%
  select(gameid, rule_idx, correct, incorrect) %>%
  mutate(explorer_acc = correct / (correct + incorrect)) %>%
  mutate(rule_type = floor(rule_idx/10))

complete_test_student <- scores_complete_games %>%
  filter(role == "student") %>%
  mutate(correct = hits + correct_rejections) %>%
  mutate(incorrect = misses + false_alarms) %>%
  select(gameid, rule_idx, incorrect, correct) %>%
  mutate(student_acc = correct / (correct + incorrect)) %>%
  mutate(rule_type = floor(rule_idx/10))

complete_test_explorer_summary <- complete_test_explorer %>%
  group_by(rule_idx) %>%
  tidyboot_mean(column = explorer_acc) %>%
  rename(avg_explorer_acc = mean) %>%
  rename(explorer_ci_lower = ci_lower) %>%
  rename(explorer_ci_upper = ci_upper )%>%
  mutate(rule_type = floor(rule_idx/10))

complete_test_student_summary <- complete_test_student %>%
  group_by(rule_idx) %>%
  tidyboot_mean(column = student_acc) %>%
  rename(avg_student_acc = mean) %>%
  rename(student_ci_lower = ci_lower) %>%
  rename(student_ci_upper = ci_upper) %>%
  mutate(rule_type = floor(rule_idx/10))

complete_test <- bind_cols(complete_test_explorer, complete_test_student) %>%
    select(rule_idx, student_acc, explorer_acc, rule_type) 
complete_test$rule_idx <- as.factor(complete_test$rule_idx)
complete_test$rule_type <- as.factor(complete_test$rule_type)
complete_test <- complete_test %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))

complete_test_summary <- bind_cols(complete_test_explorer_summary, complete_test_student_summary) %>% bind_cols(concept_summary) %>%
  select(rule_idx, avg_student_acc, avg_explorer_acc, student_ci_lower, student_ci_upper, explorer_ci_lower,  explorer_ci_upper, p_test_belongs_to_concept, phrase, kind, name, type, rule_type, chance_rate) %>%
  rename(student_acc = avg_student_acc) %>%
  rename(explorer_acc = avg_explorer_acc)   
complete_test_summary$rule_idx <- as.factor(complete_test_summary$rule_idx)
complete_test_summary$rule_type <- as.factor(complete_test_summary$rule_type)
complete_test_summary <- complete_test_summary %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))

```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(complete_test_summary
       , aes(x=student_acc, y=explorer_acc, color=rule_type_text, label=rule_idx)) +
  geom_point(size = 6) +
  theme_few() +
  guides(color = guide_legend("Rule Type")) +
  geom_text(hjust = 0.01, nudge_x = 0.01, show.legend = FALSE) +
  geom_point(data = complete_test, size = 2, alpha=0.7) +
  labs(
    title = "Student Accuracy vs. Teacher Accuracy",
    x = "Student Accuracy",
    y = "Explorer Acccuracy"
  ) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  geom_errorbar(aes(ymax = explorer_ci_lower, ymin = explorer_ci_upper), alpha=0.3) +
  geom_errorbarh(aes(xmax = student_ci_lower, xmin = student_ci_upper), alpha=0.3) +
  coord_fixed() +
  scale_x_continuous(limits = c(0.0, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0)) +
  scale_y_continuous(limits = c(0.0, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0) )

```
```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(complete_test_summary, aes(x=explorer_acc, xend=student_acc, y=rule_idx)) + 
  theme_few() +
  geom_segment(
    aes(
      color=rule_type_text,
      x=explorer_acc, 
      xend=student_acc, 
      y=rule_idx, 
      yend=rule_idx),
    size=2) +
  geom_dumbbell(
    size=0,
    size_x=4,
    size_xend = 4,
    colour_x="black",
    colour_xend = "gray") +
    labs(
      x="Accuracy",
      y="Concept Rule",
      title="Concept Rule Accuracies") +
  geom_point(aes(x=chance_rate, y=rule_idx, shape=15), size=3, inherit.aes=F, show.legend = F, color="orange") +
  scale_shape_identity() + 
  guides(color = guide_legend("Rule Type")) +
  scale_x_continuous(limits = c(0.10, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0)) + 
  scale_y_discrete(labels = c(
    "flowers: orange stems",
    "flowers: thorns present",
    "fish: white fangs",
    "fish: whiskers present",
    "bugs: orange head",
    "bugs: no wings",
    "birds: tail present",
    "birds: purple tail",
    "trees: purple berries",
    "trees: no leaves",

    "flowers: purple stem AND thorn",
    "flowers: orange petals AND purple center",
    "fish: white stripes AND whiskers  present",
    "fish: orange bodies AND purple stripe",
    "bugs: purple legs AND white head",
    "bugs: wings AND antennae present",
    "birds: purple wings AND crest present",
    "birds: orange wings AND tail present",
    "trees: orange trunk AND berries present",
    "trees: purple leaves AND berries present",

    "flowers: purple petals OR thorns present",
    "flowers: orange stems OR thorns present",
    "fish: orange bodies OR fangs present",
    "fish: white stripes OR whiskers present",
    "bugs: orange antennae OR wings present",
    "bugs: purple wings OR white legs",
    "birds: orange tail OR white wings",
    "birds: orange crest OR purple wings",
    "trees: purple berries OR white trunk",
    "trees: white leaves OR orange berries",

    "flowers: (purple stem AND white petals) OR orange center",
    "flowers: (thorns present AND purple petals) OR orange stem",
    "fish: (orange body AND purple stripes) OR whiskers present",
    "fish: (white body AND orange stripes) OR fangs present",
    "bugs: (purple legs AND white head) OR orange wings",
    "bugs: (white legs AND purple wings) OR orange antennae",
    "birds: (purple wings AND white crest) OR white tail",
    "birds: (purple crest AND purple tail) OR orange wings",
    "trees: (orange berries AND purple trunks) OR white leaves",
    "trees: (leaves present AND berries present) OR orange trunks",

    "flowers: (purple center OR orange stem) AND thorns present",
    "flowers: (purple stem OR thorns present) AND white center",
    "fish: (orange body OR fangs present) AND whiskers present",
    "fish: (white stripes OR purple body) AND whiskers present",
    "bugs: (antennae present OR wings present) AND purple body",
    "bugs: (white head OR orange antennae) AND purple legs",
    "birds: (orange tail OR white wings) AND orange crest",
    "birds: (white crest OR orange wings) AND tail present",
    "trees: (purple trunks OR white leaves) AND orange berries",
    "trees: (orange trunks OR berries present) AND white leaves"
  )
)
```

## Concept Type Accuracy Comparison
```{r}
complete_type_summary <- scores_complete_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10)
  ) %>%
  group_by(rule_type, role) %>%
  tidyboot_mean(column = acc)
complete_type_summary$rule_type <- as.factor(complete_type_summary$rule_type)
complete_type_summary <- complete_type_summary %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))
complete_type_summary$role <- as.factor(complete_type_summary$role)
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(complete_type_summary, aes(rule_type_text, fill=role, y=empirical_stat)) + 
  geom_col(position='dodge') +  
  labs(
    title = "Concept Type Performance",
    x = "Concept Type",
    y = "Accuracy %"
  ) + 
  geom_errorbar(aes(x=rule_type_text, ymin=ci_lower, ymax=ci_upper), color="black", width=0.5, position=position_dodge(.9)) 
```

## Concept Type Normalized Accuracy Comparison
```{r}
complete_test_concept_type_summary_normalized <- scores_complete_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10),
    chance_rate = concept_summary$chance_rate[rule_idx + 1],
    norm_acc = (acc - chance_rate)/(1 - chance_rate)
  ) %>%
  group_by(rule_type, role) %>%
  tidyboot_mean(column = norm_acc)

complete_test_concept_type_summary_normalized$rule_type <- as.factor(complete_test_concept_type_summary_normalized$rule_type)

complete_test_concept_type_summary_normalized <- complete_test_concept_type_summary_normalized %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))

complete_test_concept_type_summary_normalized$role <- as.factor(complete_test_concept_type_summary_normalized$role)
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(complete_test_concept_type_summary_normalized, aes(rule_type_text, fill=role, y=empirical_stat)) + 
  geom_col(position='dodge') +  
  labs(
    title = "Concept Type Performance",
    x = "Concept Type",
    y = "Normalized Accuracy %"
  ) + 
  geom_errorbar(aes(x=rule_type_text, ymin=ci_lower, ymax=ci_upper), color="black", width=0.5, position=position_dodge(.9)) +
  theme_few()
```

## Hits, Misses, False Alarms, Correct Rejections Breakdown (Counts)
```{r}
complete_test_perf_breakdown <- scores_complete_games %>%
  select(role, rule_idx, hits, misses, correct_rejections, false_alarms) %>%
  group_by(role, rule_idx) %>% 
  summarise_all(sum) %>%
  mutate(rule_type = floor(rule_idx/10))

complete_test_perf_breakdown$rule_idx <- as.factor(complete_test_perf_breakdown$rule_idx)
complete_test_perf_breakdown$rule_type <- as.factor(complete_test_perf_breakdown$rule_type)
complete_test_perf_breakdown <- complete_test_perf_breakdown %>%
  mutate(rule_type_text = 
           fct_recode(rule_type,
              "Single Feature" = "0",
              "Conjunction" = "1",
              "Disjunction" = "2",
              "Conjunctive Disjunction" = "3",
              "Disjunctive Conjunction" = "4",
            ),
        rule_idx_text = 
          fct_recode(rule_idx,
            "flowers: orange stems" = "0",
            "flowers: thorns present" = "1",
            "fish: white fangs" = "2",
            "fish: whiskers present" = "3",
            "bugs: orange head" = "4",
            "bugs: no wings" = "5",
            "birds: tail present" = "6",
            "birds: purple tail" = "7",
            "trees: purple berries" = "8",
            "trees: no leaves" = "9",
        
            "flowers: purple stem AND thorn" = "10",
            "flowers: orange petals AND purple center" = "11",
            "fish: white stripes AND whiskers  present"= "12" ,
            "fish: orange bodies AND purple stripe" = "13",
            "bugs: purple legs AND white head" = "14",
            "bugs: wings AND antennae present" = "15",
            "birds: purple wings AND crest present" = "16",
            "birds: orange wings AND tail present" = "17",
            "trees: orange trunk AND berries present" = "18",
            "trees: purple leaves AND berries present"= "19",
        
            "flowers: purple petals OR thorns present" = "20",
            "flowers: orange stems OR thorns present" = "21",
            "fish: orange bodies OR fangs present" = "22",
            "fish: white stripes OR whiskers present" = "23",
            "bugs: orange antennae OR wings present" = "24",
            "bugs: purple wings OR white legs" = "25",
            "birds: orange tail OR white wings" = "26",
            "birds: orange crest OR purple wings" = "27",
            "trees: purple berries OR white trunk" = "28",
            "trees: white leaves OR orange berries" = "29",
        
            "flowers: (purple stem AND white petals) OR orange center" = "30",
            "flowers: (thorns present AND purple petals) OR orange stem" = "31",
            "fish: (orange body AND purple stripes) OR whiskers present" = "32",
            "fish: (white body AND orange stripes) OR fangs present" = "33",
            "bugs: (purple legs AND white head) OR orange wings" = "34",
            "bugs: (white legs AND purple wings) OR orange antennae" = "35",
            "birds: (purple wings AND white crest) OR white tail" = "36",
            "birds: (purple crest AND purple tail) OR orange wings" = "37",
            "trees: (orange berries AND purple trunks) OR white leaves" = "38",
            "trees: (leaves present AND berries present) OR orange trunks" = "39",
        
            "flowers: (purple center OR orange stem) AND thorns present" = "40",
            "flowers: (purple stem OR thorns present) AND white center" = "41",
            "fish: (orange body OR fangs present) AND whiskers present" = "42",
            "fish: (white stripes OR purple body) AND whiskers present" = "43",
            "bugs: (antennae present OR wings present) AND purple body" = "44",
            "bugs: (white head OR orange antennae) AND purple legs" = "45",
            "birds: (orange tail OR white wings) AND orange crest" = "46",
            "birds: (white crest OR orange wings) AND tail present" = "47",
            "trees: (purple trunks OR white leaves) AND orange berries" = "48",
            "trees: (orange trunks OR berries present) AND white leaves" = "49")
)

complete_test_perf_breakdown <- complete_test_perf_breakdown %>%
  melt(measure.vars = c("hits", "misses", "correct_rejections", "false_alarms"))

complete_test_perf_sums <- complete_test_perf_breakdown %>%
  group_by(rule_idx, rule_type, rule_type_text, rule_idx_text, role) %>%
  summarise(norm_constant = sum(value))

complete_test_perf_breakdown_normalized <- complete_test_perf_breakdown %>% 
  inner_join(., complete_test_perf_sums) %>%
  mutate(value = value/norm_constant) %>%
  select(rule_idx, rule_type, rule_type_text, rule_idx_text, value, role, variable)
```

## Hits, Misses, False Alarms, Correct Rejections Breakdown (Proportions)
```{r fig.width=10, fig.height=10, echo=FALSE}
ggplot(complete_test_perf_breakdown_normalized, aes(x = reorder(role, desc(role)), y = value, fill = variable)) + 
  geom_bar(stat = 'identity', position = 'stack') + facet_wrap(rule_idx_text ~ rule_type_text, ncol=10,  labeller = label_wrap_gen(width=30)) +
    labs(
      title = "Teacher & Student Performance Across Concept Rules",
      y = "Proportions"
  )
```

## Hamming Distance
```{r}
# Convert true/false to 1s and 0s
test_complete_games$turker_label <- as.logical(test_complete_games$turker_label)
test_complete_games$turker_label[test_complete_games$turker_label == "true"] <- 1
test_complete_games$turker_label[test_complete_games$turker_label == "false"] <- 0

complete_all_games_wide <- test_complete_games %>%
  select(role, stim_num, rule_idx, gameid, turker_label) %>%
  spread(role, turker_label)

# Compute Hamming Distances for Concepts
gold_hamming_distances <- complete_all_games_wide %>%
  group_by(rule_idx, gameid) %>%
  summarize(d = sum(explorer != student))


# for ri in rule_idx
#   for sn in stim_num
#     new.df <- filter(test_all_games_split, stim_num == 5, rule_idx == 0)
#     random.explorer <- new.df[sample(1:nrow(new.df)), "explorer"]
# 
#     
# test_all_games_split
# 
# new.df$new_explorer <- random.explorer
# sample(1:nrow(new.df))
# 
# new.df
```

# All Games
```{r}
# Load Test Trial Responses
temp <- list.files(
  "../../../data/mp-game-6/all_games/logTest",
  pattern="*.csv",
  full.names=TRUE
)
test_all_games <- do.call(rbind, lapply(temp, read.csv, sep=""))

# Load Test Summary Stats
temp <- list.files(
    "../../../data/mp-game-6/all_games/logScores",
  pattern="*.csv",
  full.names=TRUE
)
scores_all_games <- do.call(rbind, lapply(temp, read.csv, sep=""))

# Load Chat Messages
temp <- list.files(
    "../../../data/mp-game-6/all_games/chatMessage",
  pattern="*.tsv",
  full.names=TRUE
)
msgs_all_games <-do.call(rbind, lapply(temp, readr::read_tsv)) %>%
  group_by(gameid)
```

## Distribution of All Data
```{r}
num_all_games_played <- scores_all_games %>%
  count(rule_idx) %>%
  mutate(n = ceiling(n/2))
num_all_games_played$n <- as.factor(num_all_games_played$n)
ggplot(data=num_all_games_played, aes(x=rule_idx, y=n), ) +
  geom_bar(stat="identity") +
  labs(
    title = "Data Distribution of All Games",
    x = "Rule Index",
    y = "Number of Samples"
  ) +
  ylim(0, 10) +
  scale_y_discrete()
```

## Student Performance Vs. Teacher Performance
```{r}
all_test <- scores_all_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10)
  )

all_test_summary <- all_test %>%
  group_by(rule_idx, role) %>%
  tidyboot_mean(column = acc) %>%
  mutate(rule_type = floor(rule_idx/10))

all_test <- bind_cols(
  all_test %>%
    filter(role == "student") %>%
    select(rule_idx, gameid, acc, rule_type) %>%
    rename(student_acc = acc),
  all_test %>%
    filter(role == "explorer") %>%
    select(acc) %>%
    rename(explorer_acc = acc)
)
all_test$rule_idx <- as.factor(all_test$rule_idx)
all_test$rule_type <- as.factor(all_test$rule_type)
all_test <- all_test %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))


all_test_summary <- bind_cols(
  all_test_summary %>%
    filter(role == "student") %>%
    select(rule_idx, rule_type, empirical_stat, ci_lower, ci_upper) %>%
    rename(
      student_acc = empirical_stat,
      student_ci_lower = ci_lower,
      student_ci_upper = ci_upper
    ),
  all_test_summary %>%
    filter(role == "explorer") %>%
    select(rule_idx,empirical_stat, ci_lower, ci_upper) %>%
    rename(
      explorer_acc = empirical_stat,
      explorer_ci_lower = ci_lower,
      explorer_ci_upper = ci_upper
    )
  ) %>%
  bind_cols(concept_summary)
all_test_summary$rule_idx <- as.factor(all_test_summary$rule_idx)
all_test_summary$rule_type <- as.factor(all_test_summary$rule_type)

all_test_summary <- all_test_summary %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(all_test_summary, aes(x=student_acc, y=explorer_acc, color=rule_type_text, label=rule_idx)) +
  geom_point(size = 6) +
  theme_few() +
  guides(color = guide_legend("Rule Type")) +
  geom_text(hjust = 0.01, nudge_x = 0.01, show.legend = FALSE) +
  geom_point(data = all_test, size = 2, alpha=0.7) +
  labs(
    title = "Student Acc vs. Explorer Acc",
    x = "Student Acc.",
    y = "Explorer Acc."
  ) +
  geom_abline(intercept = 0, slope = 1, linetype = 2) +
  geom_errorbar(aes(ymax = explorer_ci_lower, ymin = explorer_ci_upper), alpha=0.3) +
  geom_errorbarh(aes(xmax = student_ci_lower, xmin = student_ci_upper), alpha=0.3) +
  coord_fixed() +
  scale_x_continuous(limits = c(0.0, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0)) +
  scale_y_continuous(limits = c(0.0, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0) )
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(all_test_summary, aes(x=explorer_acc, xend=student_acc, y=rule_idx)) + 
  theme_few() +
  geom_segment(
    aes(
      color=rule_type_text,
      x=explorer_acc, 
      xend=student_acc, 
      y=rule_idx, 
      yend=rule_idx),
    size=2) +
  geom_dumbbell(
    size=0,
    size_x=4,
    size_xend = 4,
    colour_x="black",
    colour_xend = "gray") +
    labs(
      x="Accuracy (Proportion Correct)",
      y="Concept Rule",
      title="Concept Rule Accuracies") +
  geom_point(aes(x=chance_rate, y=rule_idx, shape=15), size=3, inherit.aes=F, show.legend = F, color="orange") +
  scale_shape_identity() + 
  guides(color = guide_legend("Rule Type")) +
  scale_x_continuous(limits = c(0.10, 1.0), breaks = c(0.25, 0.5, 0.75, 1.0)) + 
  scale_y_discrete(labels = c(
    "flowers: orange stems",
    "flowers: thorns present",
    "fish: white fangs",
    "fish: whiskers present",
    "bugs: orange head",
    "bugs: no wings",
    "birds: tail present",
    "birds: purple tail",
    "trees: purple berries",
    "trees: no leaves",

    "flowers: purple stem AND thorn",
    "flowers: orange petals AND purple center",
    "fish: white stripes AND whiskers  present",
    "fish: orange bodies AND purple stripe",
    "bugs: purple legs AND white head",
    "bugs: wings AND antennae present",
    "birds: purple wings AND crest present",
    "birds: orange wings AND tail present",
    "trees: orange trunk AND berries present",
    "trees: purple leaves AND berries present",

    "flowers: purple petals OR thorns present",
    "flowers: orange stems OR thorns present",
    "fish: orange bodies OR fangs present",
    "fish: white stripes OR whiskers present",
    "bugs: orange antennae OR wings present",
    "bugs: purple wings OR white legs",
    "birds: orange tail OR white wings",
    "birds: orange crest OR purple wings",
    "trees: purple berries OR white trunk",
    "trees: white leaves OR orange berries",

    "flowers: (purple stem AND white petals) OR orange center",
    "flowers: (thorns present AND purple petals) OR orange stem",
    "fish: (orange body AND purple stripes) OR whiskers present",
    "fish: (white body AND orange stripes) OR fangs present",
    "bugs: (purple legs AND white head) OR orange wings",
    "bugs: (white legs AND purple wings) OR orange antennae",
    "birds: (purple wings AND white crest) OR white tail",
    "birds: (purple crest AND purple tail) OR orange wings",
    "trees: (orange berries AND purple trunks) OR white leaves",
    "trees: (leaves present AND berries present) OR orange trunks",

    "flowers: (purple center OR orange stem) AND thorns present",
    "flowers: (purple stem OR thorns present) AND white center",
    "fish: (orange body OR fangs present) AND whiskers present",
    "fish: (white stripes OR purple body) AND whiskers present",
    "bugs: (antennae present OR wings present) AND purple body",
    "bugs: (white head OR orange antennae) AND purple legs",
    "birds: (orange tail OR white wings) AND orange crest",
    "birds: (white crest OR orange wings) AND tail present",
    "trees: (purple trunks OR white leaves) AND orange berries",
    "trees: (orange trunks OR berries present) AND white leaves"
  )
)
```

## Concept Type Accuracy Comparison
```{r}
all_test_concept_type_summary <- scores_all_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10)
  ) %>%
  group_by(rule_type, role) %>%
  tidyboot_mean(column = acc)

all_test_concept_type_summary$rule_type <- as.factor(all_test_concept_type_summary$rule_type)

all_test_concept_type_summary <- all_test_concept_type_summary %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4"
  ))


all_test_concept_type_summary$role <- as.factor(all_test_concept_type_summary$role)
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(all_test_concept_type_summary, aes(rule_type_text, fill=role, y=empirical_stat)) + 
  geom_col(position='dodge') +  
  labs(
    title = "Concept Type Performance",
    x = "Concept Type",
    y = "Accuracy %"
  ) + 
  geom_errorbar(aes(x=rule_type_text, ymin=ci_lower, ymax=ci_upper), color="black", width=0.5, position=position_dodge(.9)) 
```


```{r}
all_test_concept_type_summary <- scores_all_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10)
  ) %>%
  group_by(rule_type, rule_idx, role) %>%
  summarize(ruleIdx_acc = mean(acc)) %>% 
  group_by(rule_type, role) %>%
  tidyboot_mean(column = ruleIdx_acc)

all_test_concept_type_summary$rule_type <- as.factor(all_test_concept_type_summary$rule_type)

all_test_concept_type_summary <- all_test_concept_type_summary %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4",
  ))


all_test_concept_type_summary$role <- as.factor(all_test_concept_type_summary$role)
```
```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(all_test_concept_type_summary, aes(rule_type_text, fill=role, y=empirical_stat)) + 
  geom_col(position='dodge') +  
  labs(
    title = "Concept Type Performance",
    x = "Concept Type",
    y = "Accuracy %"
  ) + 
  geom_errorbar(aes(x=rule_type_text, ymin=ci_lower, ymax=ci_upper), color="black", width=0.5, position=position_dodge(.9)) 
```

## Concept Type Normalized Accuracy Comparison
```{r}
all_test_concept_type_summary_normalized <- scores_all_games %>%
  mutate(
    correct = hits + correct_rejections,
    incorrect = misses + false_alarms,
    acc = correct / (correct + incorrect),
    rule_type = floor(rule_idx/10),
    chance_rate = concept_summary$chance_rate[rule_idx + 1],
    norm_acc = (acc - chance_rate)/(1 - chance_rate)
  ) %>%
  group_by(rule_type, role) %>%
  tidyboot_mean(column = norm_acc)

all_test_concept_type_summary_normalized$rule_type <- as.factor(all_test_concept_type_summary_normalized$rule_type)

all_test_concept_type_summary_normalized <- all_test_concept_type_summary_normalized %>%
  mutate(rule_type_text = fct_recode(rule_type,
    "Single Feature" = "0",
    "Conjunction" = "1",
    "Disjunction" = "2",
    "Conjunctive Disjunction" = "3",
    "Disjunctive Conjunction" = "4",
  ))

all_test_concept_type_summary_normalized$role <- as.factor(all_test_concept_type_summary_normalized$role)
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggplot(all_test_concept_type_summary_normalized, aes(rule_type_text, fill=role, y=empirical_stat)) + 
  geom_col(position='dodge') +  
  labs(
    title = "Concept Type Performance",
    x = "Concept Type",
    y = "Normalized Accuracy %"
  ) + 
  geom_errorbar(aes(x=rule_type_text, ymin=ci_lower, ymax=ci_upper), color="black", width=0.5, position=position_dodge(.9)) +
  theme_few()
```

## Hits, Misses, False Alarms, Correct Rejections Breakdown (Counts)
```{r}
all_test_perf_breakdown <- scores_all_games %>%
  select(role, rule_idx, hits, misses, correct_rejections, false_alarms) %>%
  group_by(role, rule_idx) %>% 
  summarise_all(sum) %>%
  mutate(rule_type = floor(rule_idx/10))

all_test_perf_breakdown$rule_idx <- as.factor(all_test_perf_breakdown$rule_idx)
all_test_perf_breakdown$rule_type <- as.factor(all_test_perf_breakdown$rule_type)
all_test_perf_breakdown <- all_test_perf_breakdown %>%
  mutate(rule_type_text = 
           fct_recode(rule_type,
              "Single Feature" = "0",
              "Conjunction" = "1",
              "Disjunction" = "2",
              "Conjunctive Disjunction" = "3",
              "Disjunctive Conjunction" = "4",
            ),
        rule_idx_text = 
          fct_recode(rule_idx,
            "flowers: orange stems" = "0",
            "flowers: thorns present" = "1",
            "fish: white fangs" = "2",
            "fish: whiskers present" = "3",
            "bugs: orange head" = "4",
            "bugs: no wings" = "5",
            "birds: tail present" = "6",
            "birds: purple tail" = "7",
            "trees: purple berries" = "8",
            "trees: no leaves" = "9",
        
            "flowers: purple stem AND thorn" = "10",
            "flowers: orange petals AND purple center" = "11",
            "fish: white stripes AND whiskers  present"= "12" ,
            "fish: orange bodies AND purple stripe" = "13",
            "bugs: purple legs AND white head" = "14",
            "bugs: wings AND antennae present" = "15",
            "birds: purple wings AND crest present" = "16",
            "birds: orange wings AND tail present" = "17",
            "trees: orange trunk AND berries present" = "18",
            "trees: purple leaves AND berries present"= "19",
        
            "flowers: purple petals OR thorns present" = "20",
            "flowers: orange stems OR thorns present" = "21",
            "fish: orange bodies OR fangs present" = "22",
            "fish: white stripes OR whiskers present" = "23",
            "bugs: orange antennae OR wings present" = "24",
            "bugs: purple wings OR white legs" = "25",
            "birds: orange tail OR white wings" = "26",
            "birds: orange crest OR purple wings" = "27",
            "trees: purple berries OR white trunk" = "28",
            "trees: white leaves OR orange berries" = "29",
        
            "flowers: (purple stem AND white petals) OR orange center" = "30",
            "flowers: (thorns present AND purple petals) OR orange stem" = "31",
            "fish: (orange body AND purple stripes) OR whiskers present" = "32",
            "fish: (white body AND orange stripes) OR fangs present" = "33",
            "bugs: (purple legs AND white head) OR orange wings" = "34",
            "bugs: (white legs AND purple wings) OR orange antennae" = "35",
            "birds: (purple wings AND white crest) OR white tail" = "36",
            "birds: (purple crest AND purple tail) OR orange wings" = "37",
            "trees: (orange berries AND purple trunks) OR white leaves" = "38",
            "trees: (leaves present AND berries present) OR orange trunks" = "39",
        
            "flowers: (purple center OR orange stem) AND thorns present" = "40",
            "flowers: (purple stem OR thorns present) AND white center" = "41",
            "fish: (orange body OR fangs present) AND whiskers present" = "42",
            "fish: (white stripes OR purple body) AND whiskers present" = "43",
            "bugs: (antennae present OR wings present) AND purple body" = "44",
            "bugs: (white head OR orange antennae) AND purple legs" = "45",
            "birds: (orange tail OR white wings) AND orange crest" = "46",
            "birds: (white crest OR orange wings) AND tail present" = "47",
            "trees: (purple trunks OR white leaves) AND orange berries" = "48",
            "trees: (orange trunks OR berries present) AND white leaves" = "49")
)

all_test_perf_breakdown <- all_test_perf_breakdown %>%
  melt(measure.vars = c("hits", "misses", "correct_rejections", "false_alarms"))

all_test_perf_sums <- all_test_perf_breakdown %>%
  group_by(rule_idx, rule_type, rule_type_text, rule_idx_text, role) %>%
  summarise(norm_constant = sum(value))

all_test_perf_breakdown_normalized <- all_test_perf_breakdown %>% 
  inner_join(., all_test_perf_sums) %>%
  mutate(value = value/norm_constant) %>%
  select(rule_idx, rule_type, rule_type_text, rule_idx_text, value, role, variable)


```

## Student vs. Teacher Performance Concepts## Hits, Misses, False Alarms, Correct Rejections Breakdown (Proportions)
```{r fig.width=10, fig.height=10, echo=FALSE}
ggplot(all_test_perf_breakdown_normalized, aes(x = reorder(role, desc(role)), y = value, fill = variable)) + 
  geom_bar(stat = 'identity', position = 'stack') + facet_wrap(rule_idx_text ~ rule_type_text, ncol=10,  labeller = label_wrap_gen(width=30)) +
    labs(
      title = "Teacher & Student Performance Across Concept Rules",
      y = "Proportions"
  )
```

## Hamming Distance
```{r}
# Convert true/false to 1s and 0s
test_all_games$turker_label <- as.logical(test_all_games$turker_label)
test_all_games$turker_label[test_all_games$turker_label == "true"] <- 1
test_all_games$turker_label[test_all_games$turker_label == "false"] <- 0

test_all_games_split <- test_all_games %>%
  select(role, stim_num, rule_idx, gameid, turker_label) %>%
  spread(role, turker_label)

# Compute Hamming Distances for Concepts
gold_hamming_distances <- test_all_games_split %>%
  group_by(rule_idx, gameid) %>%
  summarize(d = sum(explorer_selection != student_selection))
head(test_all_games)

for ri in rule_idx
  for sn in stim_num
    new.df <- filter(test_all_games_split, stim_num == 5, rule_idx == 0)
    random.explorer <- new.df[sample(1:nrow(new.df)), "explorer"]

    
test_all_games_split

new.df$new_explorer <- random.explorer
sample(1:nrow(new.df))

new.df
```
